---

- name: get the current hostname
  ignore_errors: yes # Empty grep is flagged as an error due to rc: 1
  shell: hostnamectl | grep "{{ inventory_hostname }}"
  register: result

- name: set the hostname
  become: yes
  command: hostnamectl set-hostname "{{ inventory_hostname }}"
  when: result.stdout == ""

- name: update /etc/hosts with new hostname (pi)
  become: yes
  lineinfile:
    dest: /etc/hosts
    regexp: "^127.0.1.1\t"
    line: "127.0.1.1\t{{ inventory_hostname}}"
    state: present
  when: "'rpi' in group_names"

- name: update /etc/hosts with new hostname
  become: yes
  lineinfile:
    dest: /etc/hosts
    regexp: '^127\.0\.0\.1[ \t]+localhost.localdomain\tlocalhost$'
    line: "127.0.0.1\tlocalhost.localdomain\tlocalhost\t{{ inventory_hostname }}"
    state: present
  when: "'rpi' not in group_names"

- name: update cloud.cfg to preserve hostname
  become: yes
  lineinfile:
    dest: /etc/cloud/cloud.cfg
    regexp: '^preserve_hostname: false$'
    line: "preserve_hostname: true"
    state: present
  when: "'rpi' not in group_names"
