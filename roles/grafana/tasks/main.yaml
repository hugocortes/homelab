---

- name: add grafana repo
  yum_repository:
    name: grafana
    description: Grafana Repository
    baseurl: https://packages.grafana.com/oss/rpm
    repo_gpgcheck: yes
    enabled: yes
    gpgcheck: yes
    gpgkey: https://packages.grafana.com/gpg.key
    sslverify: yes
    sslcacert: /etc/pki/tls/certs/ca-bundle.crt

- name: install grafana
  yum:
    name: grafana
    state: latest

- name: stop service
  service:
    name: grafana-server
    state: stopped

- name: install required plugins
  shell: |
    grafana-cli plugins install {{ item }}
  with_items:
  - grafana-clock-panel

- name: run service as different user
  lineinfile:
    dest: /usr/lib/systemd/system/grafana-server.service
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  with_items:
  - { regexp: ^User=, line: "User={{ service_user }}" }
  - { regexp: ^Group=, line: "Group={{ service_group }}" }

- name: change service ownership
  file:
    dest: "{{ item }}"
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    recurse: yes
  with_items:
  - /var/lib/grafana
  - /etc/grafana

- name: systemd reload
  systemd:
    daemon_reload: yes

- name: enable service
  service:
    name: grafana-server
    enabled: yes

- name: start service
  service:
    name: grafana-server
    state: restarted

